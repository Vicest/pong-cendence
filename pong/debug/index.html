<!doctype html>
<body>

	<button id="duel" type="button" onclick="duel()">Duel!</button>
	<p></p>
	<button id="myToken" type="button"></button>
	<p>ROOM</p>
	<p id="room"></p>
	<p>TEST</p>
	<p id="test"></p>
	<p>SCORE</p>
	<p id="score"></p>
	<!-- (10 + 3) * 50 -->
	<canvas id="match" height=550 width=650></canvas>

	<script src="https://cdn.socket.io/4.7.2/socket.io.js"></script>
	<script>
		function duel() {
			let = opponent = prompt("Duel whom?")
			socket.emit('challenge', opponent)
		}

		function resetCanvas() {
			const canvas = document.getElementById("match")
			const ctx = canvas.getContext("2d")

			ctx.clearRect(0, 0, canvas.width, canvas.height)
		}

		function draw(match) {
			const canvas = document.getElementById("match")
			const ctx = canvas.getContext("2d")
			document.getElementById("test").innerHTML="Width: "+canvas.width+"|Height: "+canvas.height

			ctx.clearRect(0, 0, canvas.width, canvas.height)
			ctx.fillStyle = "#117711"
			ctx.fillRect(0, 0, canvas.width, canvas.height)
			ctx.fillStyle = "#FF1111" //PADDLES
			ctx.fillRect(0, match.paddlePosition[0] * 50,
				1 * 50, match.paddleSize[0] * 50)
			ctx.fillRect(600, match.paddlePosition[1] * 50,
				1 * 50, match.paddleSize[1] * 50)
			ctx.fillStyle = "#1111FF" //BALL
			ctx.fillRect((match.ball[0]+1) * 50, (match.ball[1]) * 50,
				1 * 50, 1 * 50)
		}

			let myID =(Math.random() + 1).toString(36).substring(7)

			var socket = io({
				autoConnect: false,
				auth: {
					token: myID
				}
			})
		if (socket.disconnected) {
			socket.connect()
			document.getElementById("myToken").innerHTML=myID
			function eventListenerWrapper(mySocket) {
				document.addEventListener('keydown', (event) => {
					keyboardInput(event, mySocket)
				})
			}
			eventListenerWrapper(socket)
		}

//Auto-accept / Events
		socket.on("connect_error", (err) => {
			console.log(`connect_error due to ${err.message}`);
		});

		socket.on('beChallenged', (challenger) => {
			socket.emit('challengeResponse', { accept:true, opponent:challenger })
		})

		var matchString = ""
		socket.on('roomId', (room) => {
			matchString = room;
			document.getElementById("room").innerHTML=matchString
		})

		socket.on('gameUpdate', (matchStatus) => {
			draw(matchStatus);
			document.getElementById("score").innerHTML=matchStatus.score[0]+'-'+matchStatus.score[1]
		})

		socket.on('win', () => {
			document.getElementById("score").innerHTML='You WIN!'
			resetCanvas();
		})

		socket.on('lose', () => {
			document.getElementById("score").innerHTML='You LOSE!'
			resetCanvas();
		})

		//INPUT
		function keyboardInput(event, emitter) {
			var userInput = { player:myID, match:matchString ,actions:-1 }
			switch (event.key) {
				case 'x':
					userInput.actions = 0;
					break;
				case 'z':
					userInput.actions = 1;
					break;
				default: return;
			}
			emitter.emit('playerMoves', userInput) //TODO
		}
	</script>

</body>
